#!/bin/env bash
# ./bin/do_ehmm_bw.sh
#####################################################-*-mode:shell-script-*-
##                                                                       ##
##                     Carnegie Mellon University                        ##
##                        Copyright (c) 2005                             ##
##                        All Rights Reserved.                           ##
##                                                                       ##
##  Permission is hereby granted, free of charge, to use and distribute  ##
##  this software and its documentation without restriction, including   ##
##  without limitation the rights to use, copy, modify, merge, publish,  ##
##  distribute, sublicense, and/or sell copies of this work, and to      ##
##  permit persons to whom this work is furnished to do so, subject to   ##
##  the following conditions:                                            ##
##   1. The code must retain the above copyright notice, this list of    ##
##      conditions and the following disclaimer.                         ##
##   2. Any modifications must be clearly marked as such.                ##
##   3. Original authors' names are not deleted.                         ##
##   4. The authors' names are not used to endorse or promote products   ##
##      derived from this software without specific prior written        ##
##      permission.                                                      ##
##                                                                       ##
##  CARNEGIE MELLON UNIVERSITY AND THE CONTRIBUTORS TO THIS WORK         ##
##  DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING      ##
##  ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT   ##
##  SHALL CARNEGIE MELLON UNIVERSITY NOR THE CONTRIBUTORS BE LIABLE      ##
##  FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES    ##
##  WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN   ##
##  AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,          ##
##  ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF       ##
##  THIS SOFTWARE.                                                       ##
##                                                                       ##
###########################################################################
##                                                                       ##
##  Do EHMM labeling bw                                                  ##
##                                                                       ##
###########################################################################
# to be run in the VOX directory
set -euo pipefail -
    LANG=C; export LANG
    export FESTVOXDIR
    EHMMDIR=$FESTVOXDIR/src/ehmm
    export EHMMDIR
    vanilla=0
    # nombre de cpus devrait dépendre de l'utilisateur
    # est en plus à chaque fois recalculé
    # est fixé 
    # nde_viterbi=0 # # non-deterministic Processing Flag
    # maxIters=30 # default 30
    # en plus des
    #Numbers (1, 0): Sequential Flag, Retrain Flag
    #Numbers (0, 0, 0): Fully-Connected Flag, Perturbation Flag, Skip-Flag
    # pas de suivi par un tail -F log
    # pas de traitement d'erreurs prompts recalés
    # élimination des prompts ayant entraînés des Nan de façon répétés non envisagée
# at minima
if [[ -x '/bin/find_num_available_cpu' ]]; then 
    { echo 'missing executable /bin/find_num_available_cpu' ; exit 66 ; } 
fi

if [[ -f 'ehmm/mod/model101.txt' ]] ; then
# test on part d'un fichier vide
    echo "backup .. in case"
    cp -b ehmm/mod/model101.txt ehmm/mod/model101.bak
    rm ehmm/mod/model101.txt
    # il sera recréé vide ou pas suspens
    #exit 0
fi

# if [[ ! -f ehmm/etc/mysp_settings ]]  || [[ ! -s etc/txt.phseq.data.int ]]; then
#    echo "ehmm/etc/ph_list.int ehmm/etc/ph_list.int should have been previously generated by a previous do_ehmm_feats ou pas ? NO" 
#fi
    vanilla=1
if [[ "$vanilla" == "1" ]]; then
    echo "EHMM baum-welch re-estimation"
    num_cpus=$(./bin/find_num_available_cpu)
    # /§\ SC2154 (warning): num_cpu is referenced but not assigned (did you mean 'num_cpus'?
    echo "Using $num_cpus threads"
    #SC2086 (info): Double quote to prevent globbing and word splitting.
    "$EHMMDIR"/bin/ehmm ehmm/etc/ph_list.int ehmm/etc/txt.phseq.data.int 1 0 ehmm/binfeat scaledft ehmm/mod 0 0 0 30 "$num_cpus"
            #Numbers (1, 0): Sequential Flag, Retrain Flag
            #Numbers (0, 0, 0): Fully-Connected Flag, Perturbation Flag, Skip-Flag
            #Numbers (30, num_cpu): Number of Max Iters, Number of multiple-threads
   exit 0
fi
if [[ ! -s 'ehmm/etc/ph_list.int_log' ]] ; then
    echo "ph_list.int_log, needed by do_ehmm_align not generated"
    exit 66
fi
# minima
if [[ ! -s ehmm/mod/log100.txt ]];  then
    echo "no proper ehmm/mod/log100.txt needed by "
    # test on part de ! -s etc/txt.phseq.data.int
    #exit 0
fi
if [[ ! -s ehmm/mod/model100.txt ]] ; then
    echo "no proper ehmm/mod/model100.txt needed by "
    exit
fi
if [[ ! -s ehmm/mod/model101.txt ]] ; then
    echo 'no proper ehmm/mod/model101.txt needed by'
    exit 0
fi
if [[ ! -f ehmm/etc/mysp_settings ]] ; then
    echo 'no proper ehmm/mod/log100.txt needed by '
    exit 0
fi

